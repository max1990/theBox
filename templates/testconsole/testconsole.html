<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test Console</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        pre.json { max-height: 50vh; overflow: auto; background: #111; color: #ddd; padding: 8px; }
    </style>
    <script>
    async function postForm(url, formId, outId){
        const form = document.getElementById(formId);
        const fd = new FormData(form);
        const btn = form.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = 'Running...';
        try {
            const res = await fetch(url, { method: 'POST', body: fd });
            const data = await res.json();
            document.getElementById(outId).textContent = JSON.stringify(data, null, 2);
        } catch(e){
            document.getElementById(outId).textContent = JSON.stringify({ok:false,error:String(e)}, null, 2);
        } finally { btn.disabled = false; btn.textContent = 'Run'; }
    }
    </script>
    </head>
<body class="container py-3">
    <div class="d-flex align-items-center mb-3">
        <h2 class="me-3">üß™ Test Console</h2>
        <span class="badge bg-{{ 'warning' if dry_run else 'success' }}">Dry-Run {{ 'ON' if dry_run else 'OFF' }}</span>
        <a class="ms-auto" href="/">‚Üê Back</a>
    </div>

    <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#sim">Simulate Input</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#slew">Camera Slew</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#vision">Vision Verify</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#seacross">SeaCross</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#all">All-Steps Test</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#trakka">Trakka Detector Mode</button></li>
    </ul>

    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="sim">
            <div class="card">
                <div class="card-body">
                    <form id="form-sim" onsubmit="event.preventDefault(); postForm('/test/simulate/droneshield','form-sim','out-sim')">
                        <div class="row g-2">
                            <div class="col"><label class="form-label">Bearing (deg)</label><input name="bearing_deg" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_BEARING_DEG','45.0') }}"></div>
                            <div class="col"><label class="form-label">RSSI (dBm)</label><input name="rssi_dbm" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_RSSI_DBM','-72') }}"></div>
                            <div class="col"><label class="form-label">Name</label><input name="name" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_NAME','DJI AUT XIA') }}"></div>
                            <div class="col"><label class="form-label">Protocol</label><input name="protocol" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_PROTOCOL','FHSS') }}"></div>
                        </div>
                        <div class="mt-3"><button type="submit" class="btn btn-primary">Run</button></div>
                    </form>
                </div>
            </div>
            <pre id="out-sim" class="json mt-2"></pre>
        </div>

        <div class="tab-pane fade" id="slew">
            <div class="card"><div class="card-body">
                <form id="form-slew" onsubmit="event.preventDefault(); postForm('/test/step/slew','form-slew','out-slew')">
                    <div class="row g-2">
                        <div class="col"><label class="form-label">Bearing (deg)</label><input name="bearing_deg" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_BEARING_DEG','45.0') }}"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary">Run</button></div>
                </form>
            </div></div>
            <pre id="out-slew" class="json mt-2"></pre>
        </div>

        <div class="tab-pane fade" id="vision">
            <div class="card"><div class="card-body">
                <form id="form-vision" onsubmit="event.preventDefault(); postForm('/test/step/vision','form-vision','out-vision')">
                    <div class="row g-2">
                        <div class="col"><label class="form-label">Track ID</label><input name="track_id" class="form-control" value="test-track"></div>
                        <div class="col"><label class="form-label">Bearing (deg)</label><input name="bearing_deg" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_BEARING_DEG','45.0') }}"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary">Run</button></div>
                </form>
            </div></div>
            <pre id="out-vision" class="json mt-2"></pre>
        </div>

        <div class="tab-pane fade" id="seacross">
            <div class="card"><div class="card-body">
                <form id="form-cls" class="mb-3" onsubmit="event.preventDefault(); postForm('/test/step/seacross/cls','form-cls','out-cls')">
                    <div class="row g-2">
                        <div class="col"><label class="form-label">Track ID</label><input name="track_id" class="form-control" value="test-track"></div>
                        <div class="col"><label class="form-label">Brand/Model</label><input name="brand_model" class="form-control" value="DJI"></div>
                        <div class="col"><label class="form-label">Affiliation</label><input name="affiliation" class="form-control" value="UNKNOWN"></div>
                        {% if not dry_run %}
                        <div class="col form-check mt-4"><input class="form-check-input" type="checkbox" name="send_live" id="send_live_cls"><label class="form-check-label" for="send_live_cls">Send Live</label></div>
                        {% endif %}
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary">Run</button></div>
                </form>

                <form id="form-sgt" onsubmit="event.preventDefault(); postForm('/test/step/seacross/sgt','form-sgt','out-sgt')">
                    <div class="row g-2">
                        <div class="col"><label class="form-label">Track ID</label><input name="track_id" class="form-control" value="test-track"></div>
                        <div class="col"><label class="form-label">Bearing (deg)</label><input name="bearing_deg" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_BEARING_DEG','45.0') }}"></div>
                        <div class="col"><label class="form-label">Distance (m)</label><input name="distance_m" class="form-control" value="1000"></div>
                        {% if not dry_run %}
                        <div class="col form-check mt-4"><input class="form-check-input" type="checkbox" name="send_live" id="send_live_sgt"><label class="form-check-label" for="send_live_sgt">Send Live</label></div>
                        {% endif %}
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary">Run</button></div>
                </form>
            </div></div>
            <pre id="out-cls" class="json mt-2"></pre>
            <pre id="out-sgt" class="json mt-2"></pre>
        </div>

        <div class="tab-pane fade" id="all">
            <div class="card"><div class="card-body">
                <form id="form-all" onsubmit="event.preventDefault(); postForm('/test/run/all','form-all','out-all')">
                    <div class="row g-2">
                        <div class="col"><label class="form-label">Bearing (deg)</label><input name="bearing_deg" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_BEARING_DEG','45.0') }}"></div>
                        <div class="col"><label class="form-label">RSSI (dBm)</label><input name="rssi_dbm" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_RSSI_DBM','-72') }}"></div>
                        <div class="col"><label class="form-label">Name</label><input name="name" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_NAME','DJI AUT XIA') }}"></div>
                        <div class="col"><label class="form-label">Protocol</label><input name="protocol" class="form-control" value="{{ env_defaults.get('TEST_DEFAULT_PROTOCOL','FHSS') }}"></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary">Run</button></div>
                </form>
            </div></div>
            <pre id="out-all" class="json mt-2"></pre>
        </div>

        <div class="tab-pane fade" id="trakka">
            <div class="card"><div class="card-body">
                <form id="form-mode" onsubmit="event.preventDefault(); postForm('/test/settings/trakka_mode','form-mode','out-mode')">
                    <div class="row g-2">
                        <div class="col-auto form-check"><input class="form-check-input" type="radio" name="mode" value="builtin" id="mode-builtin"><label class="form-check-label" for="mode-builtin">builtin</label></div>
                        <div class="col-auto form-check"><input class="form-check-input" type="radio" name="mode" value="none" id="mode-none"><label class="form-check-label" for="mode-none">none</label></div>
                        <div class="col-auto form-check"><input class="form-check-input" type="radio" name="mode" value="ours" id="mode-ours" checked><label class="form-check-label" for="mode-ours">ours</label></div>
                    </div>
                    <div class="mt-3"><button type="submit" class="btn btn-primary">Save</button></div>
                </form>
                <div class="mt-3">
                    <a class="btn btn-outline-secondary btn-sm" href="/plugins/trakka_control/status" target="_blank">Open /trakka/status</a>
                </div>
            </div></div>
            <pre id="out-mode" class="json mt-2"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


