<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaCross Sender Plugin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <h1>SeaCross Sender Plugin</h1>

    <h2>NMEA Destination</h2>
    <p>Sending NMEA messages to: <strong id="targetAddress"></strong></p>
    <p><b>Talker ID:</b> <span id="talker"></span></p>


    <h2>Errors</h2>
    <table id="errorsTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Received Events</h2>
    <table id="eventsTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Event Type</th>
                <th>Data</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Sent NMEA Messages</h2>
    <table id="nmeaTable">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Type</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        async function fetchPluginStatus() {
            const response = await fetch('./status');
            const data = await response.json();
            
            document.getElementById('targetAddress').textContent = `${data.target_ip}:${data.target_port}`;
            const talkerEl = document.getElementById('talker');
            if (talkerEl) talkerEl.textContent = data.talker_id || '';


            updateTable('errorsTable', data.errors.slice().reverse(), ['timestamp', 'message']);
            updateTable('eventsTable', data.received_events.slice().reverse(), ['timestamp', 'event_type', 'data']);
            updateTable('nmeaTable', data.sent_nmea.slice().reverse(), ['timestamp', 'type', 'details']);
        }

        function updateTable(tableId, data, columns) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = "";
            data.forEach(item => {
                let row = '<tr>';
                columns.forEach(col => {
                    let cellData = item[col];
                    if (typeof cellData === 'object') {
                        cellData = `<pre>${JSON.stringify(cellData, null, 2)}</pre>`;
                    }
                    row += `<td>${cellData}</td>`;
                });
                row += '</tr>';
                tableBody.innerHTML += row;
            });
        }

        setInterval(fetchPluginStatus, 2000);
        fetchPluginStatus();
    </script>
</body>
</html>
