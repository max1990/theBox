# Search Planner Plugin

**TL;DR**  
The Search Planner is a thin orchestrator that decides **where to look next** after a cue (bearing ¬± error), sends a **tile** to a modality (vision/radar), **waits** for the analyzer‚Äôs verdict, and **stops immediately** on the first confirmed detection.  
All angles are **relative to bow = 0¬∞**. This plugin **does not** format NMEA or contain vendor-specific parsing.

---

## What this plugin does (in plain English)

- Receives a cue like ‚Äúlook around bearing 042¬∞ ¬± 5¬∞‚Äù.
- Generates a short sequence of **tiles** (az, el, dwell, and only the knobs allowed for that modality).
- Commands the modality (e.g., Trakka camera or Dspnor radar) to execute **one tile at a time**.
- **Blocks** until the analyzer (vision/radar model) returns **true/false** for that tile.
- On the **first true**, publishes a normalized **`object.sighting.relative`** event for downstream systems to handle (e.g., SeaCross NMEA sender).
- Enforces **budgets/timeouts** and supports **preemption** if a higher-priority cue arrives.

**Boundaries (very important):**
- ‚úÖ Orchestrates tiles, waits for analyzer, publishes normalized event.  
- ‚ùå No NMEA formatting here.  
- ‚ùå No vendor normalization here.  
- ‚ùå No heavy ML here (adapters/analyzers handle that).

---

## Quick start (simulator)

> After the plugin is generated by Cursor, a simple simulator is included for demos.

1) Start your project the **usual way** (whatever you normally use, e.g., `make dev` or `python app.py`).  
2) Open the UI tab **‚ÄúSearch Planner‚Äù**.  
3) Click **‚ÄúStart Simulated Task‚Äù** to run a demo:
   - Vision sim: returns **TRUE** on a configurable tile and writes a dummy `artifact.jpg`.
   - Radar sim: returns **FALSE** a few times, then **TRUE** with a dummy `heatmap.png`.
4) Watch status update on `/search_planner/status`. The first TRUE will publish `object.sighting.relative`.

> If your repo serves docs via static hosting, links to the state machine and test plan appear on the page.

---

## Configuration (defaults live in `config.py`)

- **Budgets & timing**
  - `time_budget_ms` ‚Äî total task budget
  - `max_tiles` ‚Äî safety cap on tiles
  - `settle_ms`, `dwell_ms`, `analyzer_sla_ms` ‚Äî per-tile timings

- **Patterns & params**
  - `default_pattern` ‚Äî e.g., `"HorizonLadder"` or `"AzSpiral"`
  - `pattern_params` ‚Äî step sizes, az span, ladder elevations, etc.

- **Capabilities (per modality)**
  - Vision: may set **`zoom`** only (plus optional focus/exposure if enabled).
  - Radar: may set **`power`**, **`gain`**, **`clutter`**, etc., within bounds.

- **Artifacts**
  - `artifact_dir` ‚Äî where dummy/sim images (JPG/PNG) are stored for review.

> All knobs are **capability-gated** by the modality adapter and **clamped** to bounds.

---

## Events (contracts)

- **Input:** `object.sighting.directional` (cue)  
  _Fields:_ `bearing_deg`, `sigma_deg`, `source_type`, `confidence`, `context{...}`

- **Internal:** `search.command` (tile dispatch)  
  _Fields:_ `task_id`, `tile{az_deg,el_deg,dwell_ms,params}`, `knobs_allowed{...}`

- **Internal:** `search.tile_result` (analyzer verdict)  
  _Fields:_ `task_id`, `tile_id`, `is_true`, `score`, `meta{...}`, `artifact_path?`

- **Output:** `object.sighting.relative` (confirmed)  
  _Fields:_ `bearing`, `distance` **or** `range_is_synthetic=true` + `range_method`, `confidence(0..100)`, error bounds, `context{...}`

üëâ **Authoritative schema details are in** `docs/BRIEFING.md`. This plugin must **match those keys and types** exactly.

---

## Directory layout

plugins/
search\_planner/
plugin.py                    # Orchestrator & state machine
config.py                    # Defaults (budgets, SLA, bounds)
templates/
search\_planner.html        # Bootstrap status UI (thumbnail if artifact)
README-search\_planner.md     # (this file)

tests/
search\_planner/
unit/
test\_tiles.py
test\_state\_machine.py
test\_budgets.py
test\_knobs.py
test\_publish\_shape.py
integration/
test\_e2e\_vision.py
test\_e2e\_radar.py
test\_ui\_status.py
test\_preemption.py
test\_timeout\_recovery.py
test\_learning\_shadow\.py

docs/
SEARCH\_PLANNER\_STATE\_MACHINE.md
SEARCH\_PLANNER\_TESTPLAN.md
BRIEFING.md                    # global event schemas (existing)


## How this fits the rest of the system

- **Before**: RF/acoustic cues arrive as `object.sighting.directional`.  
- **Here**: Search Planner creates/executes tiles and waits on analyzer verdicts.  
- **After**: On confirm, publishes `object.sighting.relative`. A separate component (already in your repo) converts normalized events to **SeaCross NMEA** (CLS/SGT/etc.).



## Links

- üìò **State Machine:** `../../docs/SEARCH_PLANNER_STATE_MACHINE.md`  
- üß™ **Test Plan:** `../../docs/SEARCH_PLANNER_TESTPLAN.md`  
- üìë **Event Schemas (authoritative):** `../../docs/BRIEFING.md`  
- üß≠ **Project rules:** `../../plugin-chat-rules.md`



## FAQ

**Q: Can the planner change zoom/power/gain/etc.?**  
A: Only if the modality **explicitly allows** it via its capability profile. Vision ‚Üí `zoom`; Radar ‚Üí `power/gain/clutter` (plus any additional, bounded knobs you expose).

**Q: Where are the images/heatmaps stored?**  
A: Under `artifact_dir` (see `config.py`). The UI shows a thumbnail if present.

**Q: Does the planner ever ‚Äúauto-learn‚Äù and take control?**  
A: Not by default. A learning policy can run in **shadow mode** first. Only after it proves it consistently beats the manual policy (offline) should it be allowed to take over.



## Running tests

```bash
pytest -q tests/search_planner
# With coverage
pytest --cov=plugins/search_planner --cov-report=term-missing
```

## Contributing

* Keep the ASCII state diagram at the top of `plugin.py` in sync with the Mermaid diagram in `docs/SEARCH_PLANNER_STATE_MACHINE.md`.
* Any change to events must be reflected in `docs/BRIEFING.md` and the **publish shape** tests.
* Comment like you‚Äôre explaining to a new teammate‚Äîthis plugin will be read by non-coders.